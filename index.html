<html>
<head>
    <title>Amazing MP3</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="angular.js"></script>
    <script src="angular-route.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,700' rel='stylesheet' type='text/css'>
    <link href='css/reset.css' rel='stylesheet' type='text/css'>
    <link href='css/style.css' rel='stylesheet' type='text/css'>
    <link href='css/styles.css' rel='stylesheet' type='text/css'>
</head>
<header id="application-name">
</header>

<body ng-app="MyApp">


<div ng-view></div>

<script>

    var app = angular.module("MyApp", ["ngRoute"]);


    app.controller("SongController", function($http, $rootScope, $scope, $location, $interval){

        $rootScope.search = "";

        function loadSongs() {
            $http.get("/songs?count=20").success(function(data){
                $rootScope.songs = data;
                console.log( data );
            });
        };

        loadSongs();

        $interval(function () {
            loadSongs();
        }.bind(this), 5000);

        $scope.onViewSong = function(song)
        {
            $location.path("/songs/" + song.id);
        };

        $scope.onDeleteSong = function(songId)
        {
            for (var i = 0; i < $rootScope.songs.length; i++)
            {
                if ($rootScope.songs[i].id == songId)
                {
                    $rootScope.songs.splice(i, 1);
                    break;
                }
            }
            $http.delete("/songs/" + songId);
        };
    });

    app.controller("SongFormController", function($rootScope, $scope, $routeParams, $location, $http){

        if ($rootScope.songs)
            getSongs();
        else {
            $http.get("/songs?count=30").success(function(data){
                $rootScope.songs = data;
                console.log( data );
                getSongs();
            });
        }

        function getSongs() {
            var song;
            for (var i = 0; i < $rootScope.songs.length; i++) {
                if ($rootScope.songs[i].id == $routeParams.id) {
                    song = $rootScope.songs[i];
                    console.log(song);
                    break;
                }
            }
            if (song) {
                $scope.song = song;
            }
        }

        $scope.onSongSave = function(song)
        {
            if(typeof song.id !== 'undefined') {
                $http.put("/songs/" + song.id, song)
                        .success(function (data, status, headers) {
                            $location.path("/songs");
                        })
                        .error(function (data, status, header, config) {
                            $scope.ServerResponse =  htmlDecode("Data: " + data +
                                    "\n\n\n\nstatus: " + status +
                                    "\n\n\n\nheaders: " + header +
                                    "\n\n\n\nconfig: " + config);
                        });
            }
        }
    });

    app.directive('audios', function($sce) {
        return {
            restrict: 'A',
            scope: { code:'=' },
            replace: true,
            template: '<audio controls><source ng-src="{{url}}" type="audio/mpeg"></audio>',
            link: function (scope) {
                scope.$watch('code', function (newVal, oldVal) {
                    if (newVal !== undefined) {
                        scope.url = $sce.trustAsResourceUrl("media/" + newVal);
                    }
                });
            }
        };
    });

    app.config( function($routeProvider){
        $routeProvider
                .when("/songs", {
                    templateUrl : "songs.html",
                    controller : "SongController"
                })
                .when("/songs/:id", {
                    templateUrl : "song.html",
                    controller : "SongFormController"
                })
                .otherwise({ redirectTo : "/songs"});
    });

</script>

</body>
</html>




